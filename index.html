<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WARPRO - Warkop Meets Professional</title>

    <!-- CSS utama -->
    <link rel="stylesheet" href="css/warpro.css" />

    <!-- Core WARPRO (API + helpers) -->
    <script src="js/warpro.js" defer></script>

    <!-- Tambahan gaya + override popup & ranking cards -->
    <style>
      /* UI kecil */
      .hint{color:#666;font-size:.95rem;margin:.35rem 0 0}
      .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
      .toolbar .filters{display:flex;gap:10px;align-items:center;width:100%;max-width:640px}
      .toolbar input,.toolbar select{flex:1}
      .tag{display:inline-block;padding:4px 8px;border-radius:6px;font-size:.85rem;background:#eef2f7;border:1px solid #dbe3ee;color:#3b4859}
      .muted{color:#7f8c8d}
      .empty{padding:12px 14px;background:#fffbe6;border:1px solid #ffe8a3;color:#8a6d1d;border-radius:8px}
      .error{padding:12px 14px;background:#ffecec;border:1px solid #ffb4b4;color:#8a2323;border-radius:8px}
      .link-btn{background:transparent;border:none;color:#2980b9;cursor:pointer;padding:0;font:inherit;text-decoration:underline}

      /* Kartu job klik langsung */
      .job-card{cursor:pointer; touch-action:manipulation}
      .job-card .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:.5rem}

      /* ===== OVERRIDE POPUP: selalu center & tidak melebar ===== */
      #job-popup{
        position: fixed !important;
        inset: 0 !important;
        display: none !important;
        transform: none !important;
        top: 0 !important; left: 0 !important;
        margin: 0 !important; padding: 0 !important;
        background: rgba(0,0,0,.48) !important;
        z-index: 99999 !important;
      }
      #job-popup.show{
        display: grid !important;
        place-items: center !important;
      }
      #job-popup .popup-inner{
        width: min(92vw, 560px) !important;
        max-height: 85vh !important;
        overflow: auto !important;
        background: #fff !important;
        border-radius: 14px !important;
        padding: 18px !important;
        box-shadow: 0 12px 36px rgba(0,0,0,.25) !important;
      }
      #job-popup .popup-header{display:flex; align-items:center; gap:10px; font-weight:700; margin-bottom:10px}
      #job-popup .popup-close{margin-left:auto; font-size:20px; color:#c0392b; cursor:pointer}

      /* ===== Ranking: kartu elegan (bukan tabel) ===== */
      .ranking-grid{
        display:grid; gap:12px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .rank-card{
        display:flex; align-items:center; gap:12px;
        background:#fff; border:1px solid #eee; border-radius:14px;
        padding:12px 14px; box-shadow:0 1px 4px rgba(0,0,0,.05);
      }
      .rank-badge{
        width:40px; height:40px; flex:0 0 40px; border-radius:50%;
        display:grid; place-items:center; font-weight:800; color:#1b1f23;
        background:#f0f3f8; border:1px solid #e5eaf0;
      }
      .rank-1 .rank-badge{ background:linear-gradient(135deg,#ffe47a,#ffd54f); border-color:#f7c948 }
      .rank-2 .rank-badge{ background:linear-gradient(135deg,#e6e9ef,#cfd6e1); border-color:#cfd6e1 }
      .rank-3 .rank-badge{ background:linear-gradient(135deg,#ffd8b0,#ffb97a); border-color:#f5b27d }

      .rank-body{ flex:1; min-width:0 }
      .rank-name{ font-weight:700; overflow-wrap:anywhere }
      .rank-stats{ display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; color:#6b7280; font-size:.9rem }
      .chip{ background:#f4f6f9; border:1px solid #e5eaf0; border-radius:999px; padding:4px 8px }

      /* Mobile tweaks */
      @media (max-width: 768px){
        .toolbar .filters{flex-direction:column; align-items:stretch; max-width:none}
        .toolbar input,.toolbar select{width:100%}
        .job-grid{grid-template-columns:1fr}
        .job-card{padding:0.9rem}
      }
    </style>
  </head>
  <body>
    <header>
      <h1>WARPRO</h1>
      <p>Warkop Meets Professional - Komunitas Freelance Berbasis Warung</p>
    </header>

    <nav>
      <div>
        <a href="#tentang">Tentang</a>
        <a href="#job-board">Job Board</a>
        <a href="#komunitas">Komunitas</a>
        <a href="#rangking">Ranking</a>
      </div>
      <div id="user-nav">
        <!-- Diisi dinamis -->
        <a href="pages/login.html">Masuk</a>
      </div>
    </nav>

    <main>
      <section id="tentang">
        <h2>Tentang WARPRO</h2>
        <p>
          WARPRO menghubungkan pelanggan warung kopi/mie dengan job freelance
          melalui sistem loyalitas. Akses pekerjaan setelah login dan gabung
          komunitas.
        </p>
      </section>

      <section id="job-board">
        <div class="toolbar">
          <div>
            <h2 style="margin:0">Job Board</h2>
          </div>
          <div class="filters">
            <input type="text" id="jobSearch" placeholder="Cari pekerjaan..." aria-label="Cari pekerjaan" />
            <select id="statusFilter" aria-label="Filter status">
              <option value="">Semua Status</option>
              <option value="Belum Diambil">Belum Diambil</option>
              <option value="Sedang Berjalan">Sedang Berjalan</option>
              <option value="Selesai">Selesai</option>
            </select>
          </div>
        </div>

        <div class="job-grid" id="jobGrid"></div>
      </section>

      <section id="rangking">
        <h2>Top 5 Pekerja Terbaik</h2>
        <div id="rankingGrid" class="ranking-grid"></div>
      </section>

      <section id="komunitas">
        <h2>Komunitas WARPRO</h2>
        <p>Gabung komunitas untuk akses job eksklusif dan pasang pekerjaan melalui admin.</p>
        <button class="cta-button">Gabung Komunitas</button>
      </section>
    </main>

    <footer>
      <p>&copy; <span id="year"></span> WARPRO. All rights reserved.</p>
      <p><a href="#">Kebijakan Privasi</a> | <a href="#">Syarat & Ketentuan</a></p>
    </footer>

    <!-- Popup detail -->
    <div id="job-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
      <div class="popup-inner">
        <div class="popup-header">
          <span class="popup-close" role="button" tabindex="0" aria-label="Tutup">&times;</span>
          <span id="popup-title">Detail Pekerjaan</span>
        </div>
        <div id="popup-content"></div>
      </div>
    </div>

    <script>
      // ====== STATE & ELEMENTS ======
      let JOBS = [];
      const $grid = document.getElementById('jobGrid');
      const $popup = document.getElementById('job-popup');
      const $popupContent = document.getElementById('popup-content');

      // Ranking data (pakai data yang sama dengan tabelmu)
      const RANKING = [
        { name:'@dewi_marketing', score:98, projects:12 },
        { name:'@rizki_design',    score:91, projects:10 },
        { name:'@arya_edit',       score:87, projects:9  },
        { name:'@lia_uiux',        score:85, projects:8  },
        { name:'@fajarweb',        score:82, projects:8  },
      ];

      // ====== INIT ======
      document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('year').textContent = new Date().getFullYear();

        renderUserNav();
        renderRanking(); // <— tampilkan kartu ranking

        // Filter realtime
        document.getElementById('jobSearch')?.addEventListener('input', renderJobs);
        document.getElementById('statusFilter')?.addEventListener('change', renderJobs);

        // Popup controls
        document.querySelector('.popup-close')?.addEventListener('click', hidePopup);
        $popup?.addEventListener('click', (e) => { if (e.target === $popup) hidePopup(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hidePopup(); });

        await fetchJobs();
      });

      function renderUserNav(){
        const navDiv   = document.getElementById('user-nav');
        const loggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
        const admin    = sessionStorage.getItem('isAdmin') === 'true';
        const name     = sessionStorage.getItem('displayName') || sessionStorage.getItem('username') || 'Tamu';

        if (!navDiv) return;
        navDiv.innerHTML = loggedIn
          ? (admin
             ? `<a href="pages/admin.html">Admin</a> | <button class="link-btn" onclick="logout()">Keluar (${WARPRO_API.escapeText(name)})</button>`
             : `<a href="pages/profil.html">Profil</a> | <button class="link-btn" onclick="logout()">Keluar (${WARPRO_API.escapeText(name)})</button>`)
          : '<a href="pages/login.html">Masuk</a>';
      }

      // ====== RENDER RANKING ======
      function renderRanking(){
        const wrap = document.getElementById('rankingGrid');
        wrap.innerHTML = RANKING.map((p, idx) => `
          <article class="rank-card rank-${idx+1}">
            <div class="rank-badge">${idx+1}</div>
            <div class="rank-body">
              <div class="rank-name">${WARPRO_API.sanitize(p.name)}</div>
              <div class="rank-stats">
                <span class="chip">Skor: ${WARPRO_API.escapeText(String(p.score))}</span>
                <span class="chip">${WARPRO_API.escapeText(String(p.projects))} proyek</span>
              </div>
            </div>
          </article>
        `).join('');
      }

      // ====== API ======
      async function fetchJobs(){
        $grid.innerHTML = '<div class="empty">Memuat job…</div>';
        try{
          const { jobs = [] } = await WARPRO_API.apiCall('getJobs');
          JOBS = Array.isArray(jobs) ? jobs : [];
          renderJobs();
        }catch(e){
          $grid.innerHTML = `<div class="error">Gagal memuat job: ${WARPRO_API.escapeText(e.message)}</div>`;
        }
      }

      // ====== Helpers ======
      function getStatusColor(s){
        if (s === 'Belum Diambil')   return '#c0392b';
        if (s === 'Sedang Berjalan') return '#e67e22';
        if (s === 'Selesai')         return '#27ae60';
        return '#7f8c8d';
      }
      function fmtDate(v){
        if (!v) return '-';
        const d = new Date(v);
        if (isNaN(d)) return v;
        return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
      }

      // ====== RENDER JOB LIST ======
      function renderJobs(){
        const keyword = (document.getElementById('jobSearch')?.value || '').toLowerCase();
        const status  = document.getElementById('statusFilter')?.value || '';

        const filtered = JOBS.filter(job =>
          String(job.title||'').toLowerCase().includes(keyword) &&
          (status === '' || String(job.status) === status)
        );

        if (!filtered.length){
          $grid.innerHTML = '<div class="empty">Tidak ada pekerjaan ditemukan.</div>';
          return;
        }

        $grid.innerHTML = filtered.map((job, index) => `
          <div class="job-card"
               style="border-left:5px solid ${getStatusColor(job.status)}"
               data-idx="${index}" tabindex="0"
               role="button" aria-label="Lihat detail ${WARPRO_API.escapeAttr(job.title||'')}">
            <h3>${WARPRO_API.sanitize(job.title||'')}</h3>
            <p>
              <span class="status status-${String(job.status||'').replace(/\s+/g,'-').toLowerCase()}">
                ${WARPRO_API.sanitize(job.status||'-')}
              </span>
            </p>
            <div class="row">
              <span class="tag">Deadline: ${WARPRO_API.sanitize(fmtDate(job.deadline)||'-')}</span>
              <span class="tag">Fee: Rp${Number(job.fee||0).toLocaleString('id-ID')}</span>
              <span class="tag">Worker: ${WARPRO_API.sanitize(job.worker||'-')}</span>
            </div>
          </div>
        `).join('');

        // klik kartu atau Enter/Space untuk detail
        $grid.querySelectorAll('.job-card').forEach(card=>{
          const idx = card.dataset.idx;
          card.addEventListener('click', ()=> openJob(idx));
          card.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openJob(idx);
            }
          });
        });
      }

      // ====== POPUP DETAIL & AMBIL JOB ======
      function openJob(index){
        const job = JOBS[Number(index)];
        if (!job) return;

        const loggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
        const admin    = sessionStorage.getItem('isAdmin') === 'true';
        const canTake  = loggedIn && !admin && String(job.status) === 'Belum Diambil';

        const note = admin
          ? '<p class="hint"><em>Mode admin: tidak dapat mengambil job.</em></p>'
          : (!loggedIn ? '<p class="hint"><em>Login untuk mengambil job.</em></p>' : '');

        $popupContent.innerHTML = `
          <h3 id="popup-title" style="margin-top:0">${WARPRO_API.sanitize(job.title||'')}</h3>
          <p class="muted">${WARPRO_API.sanitize(job.description||'')}</p>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin:.6rem 0 1rem">
            <span class="tag">Status: ${WARPRO_API.sanitize(job.status||'-')}</span>
            <span class="tag">Deadline: ${WARPRO_API.sanitize(fmtDate(job.deadline)||'-')}</span>
            <span class="tag">Fee: Rp${Number(job.fee||0).toLocaleString('id-ID')}</span>
            <span class="tag">Worker: ${WARPRO_API.sanitize(job.worker||'-')}</span>
          </div>
          ${note}
          ${canTake ? `<button class="cta-button" id="btnTakeJob">Ambil Job Ini</button>` : ''}
        `;

        // tampilkan & kunci scroll body
        $popup.classList.add('show');
        document.documentElement.style.overflow = 'hidden';

        document.getElementById('btnTakeJob')?.addEventListener('click', takeJob.bind(null, job));
      }

      async function takeJob(job){
        if (!WARPRO_API.requireLogin()) return;
        try {
          const username = WARPRO_API.currentUser();
          await WARPRO_API.apiCall('takeJob', { username, jobId: job.id });
          hidePopup();
          await fetchJobs();
          alert('Job berhasil diambil!');
        } catch (e) {
          alert('Gagal ambil job: ' + e.message);
        }
      }

      function hidePopup(){
        $popup.classList.remove('show');
        document.documentElement.style.overflow = ''; // kembalikan scroll
      }
    </script>
  </body>
</html>
